<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>C·ªông ƒë·ªìng - DermAI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #f8fafc 0%, #e8f0ff 100%); padding-bottom: 76px; }
        .feed-container { max-width: 760px; margin: 12px auto; }
        .post-card { border-radius: 12px; background: #fff; box-shadow: 0 8px 20px rgba(15,23,42,0.06); padding: 12px; margin-bottom: 12px; }
        .post-header { display:flex; gap:12px; align-items:center; }
        .avatar { width:44px; height:44px; border-radius:50%; background:#e9eefb; display:inline-flex; align-items:center; justify-content:center; font-weight:700; color:#0d6efd; }
        .post-meta { font-size:0.9rem; color:#6b7280; }
        .composer { margin-bottom:12px; }
        .composer textarea { resize:vertical; min-height:64px; }
        .post-image { max-width:100%; border-radius:8px; margin-top:8px; }
    /* Ensure TinyMCE editor uses full width inside modal */
    #commentsModal .tox-tinymce, #commentsModal .tox-editor-container { width: 100% !important; }
    #commentsModal .modal-body { display:flex; flex-direction:column; gap:12px; }
    #commentsModal .tox .tox-editor-container { max-width:100% !important; }

    /* Responsive styles for mobile button layout improvements */
    @media (max-width: 576px) {
      .post-actions {
        flex-wrap: wrap;
        gap: 8px;
      }
      .post-actions button {
        flex: 1 1 45%;
        min-width: 45%;
        margin-bottom: 6px;
      }
      .post-actions button .upvote-count,
      .post-actions button .downvote-count,
      .post-actions button .comment-count {
        font-size: 0.85rem;
      }
      .post-actions .share-btn {
        flex: 1 1 100%;
        min-width: 100%;
      }
    }
    </style>
    <style>
      /* Comment card vote button fixes: keep them compact and inline */
      .comments-list .comment-card .card-body { padding: .5rem; }
      .comment-card .text-end.ms-3 { width: auto; display:inline-flex; align-items:center; gap:6px; }
      .comment-upvote, .comment-downvote {
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: .25rem .5rem !important;
        min-width: 36px !important;
        height: 32px !important;
        line-height: 1 !important;
      }
      .comment-upvote span, .comment-downvote span { margin-left: .4rem; font-size: .9rem; }
      /* Ensure modal buttons don't get forced full-width inside comment area */
      #commentsModal .btn { width: auto !important; }

      /* Responsive fixes for comment vote buttons on mobile */
      @media (max-width: 576px) {
        .comment-card .text-end.ms-3 {
          gap: 4px;
        }
        .comment-upvote, .comment-downvote {
          min-width: 28px !important;
          height: 28px !important;
          padding: .2rem .4rem !important;
          font-size: 0.85rem !important;
        }
        .comment-upvote span, .comment-downvote span {
          font-size: 0.75rem !important;
          margin-left: 0.2rem !important;
        }
        /* Additional fixes for comment vote buttons inside modal */
        #commentsModal .comment-upvote, #commentsModal .comment-downvote {
          min-width: 24px !important;
          height: 24px !important;
          padding: .15rem .3rem !important;
          font-size: 0.75rem !important;
        }
        #commentsModal .comment-upvote span, #commentsModal .comment-downvote span {
          font-size: 0.65rem !important;
          margin-left: 0.1rem !important;
        }
        /* Prevent horizontal overflow in modal */
        #commentsModal .modal-body {
          overflow-x: hidden;
        }
      }
    </style>
</head>
<body class="vh-100 d-flex flex-column align-items-center">
    <div class="feed-container w-100">
        <div class="d-flex align-items-center mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="#0d6efd" class="me-2" viewBox="0 0 16 16">
                <path d="M10.5 2a1 1 0 0 0-.832.445L8.94 4H7.06L6.332 2.445A1 1 0 0 0 5.5 2h-3A1.5 1.5 0 0 0 1 3.5v9A1.5 1.5 0 0 0 2.5 14h11A1.5 1.5 0 0 0 15 12.5v-9A1.5 1.5 0 0 0 13.5 2h-3zM8 12a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
            </svg>
            <div class="brand fs-4 fw-bold me-3">DermAI</div>
            <div class="hint text-muted">C·ªông ƒë·ªìng - Chia s·∫ª v√† h·ªèi ƒë√°p</div>
        </div>

        {% if request.user.is_authenticated %}
    <div class="post-card composer">
      <form method="post" action="{% url 'create_post' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div>
          <div class="d-flex align-items-center gap-2 mb-2">
            <img src="{{ profile.avatar.url }}" style="width:50px;height:50px;" class="rounded-circle shadow"/>
            <div class="fw-semibold">{{ request.user.username }}</div>
          </div>
          <textarea id="tinyContent" name="content" class="form-control shadow" placeholder="B·∫°n ƒëang nghƒ© g√¨?" aria-label="Vi·∫øt b√†i"></textarea>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div>
              <button type="submit" class="btn btn-primary">ƒêƒÉng</button>
            </div>
          </div>
        </div>
      </form>
    </div>
        {% else %}
        <div class="post-card text-center text-muted">Vui l√≤ng <a href="{% url 'login' %}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ tham gia c·ªông ƒë·ªìng.</div>
        {% endif %}

        <!-- feed items -->
        {% for post in posts %}
        <article class="post-card" id="post-{{ post.id|default:forloop.counter }}">
            <div class="post-header">
                <img src="{{ post.author.avatar.url }}" style="width:50px;height:50px;" class="rounded-circle"/>
                <div style="flex:1">
                    <div class="fw-semibold">{% if post.author %}{{ post.author.user.username }}{% else %}Ng∆∞·ªùi d√πng{% endif %}</div>
                    <div class="post-meta">{{ post.created_at|date:"d M Y H:i" }}</div>
                </div>
                <div class="text-muted small">{% if request.user == post.author.user %}
                    <a href="{% url 'edit_post' post.id %}">S·ª≠a</a> ‚Ä¢ 
                    <form method="post" action="{% url 'delete_post' post.id %}" style="display: inline;" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-link text-danger p-0 border-0 bg-transparent">X√≥a</button>
                    </form>
                {% endif %}</div>
            </div>

            <div class="post-body mt-2">
                {% if post.content %}
                    {{ post.content|safe }}
                {% else %}
                    <p>{{ post.content|linebreaksbr }}</p>
                {% endif %}

            </div>

      <div class="post-actions d-flex gap-3 mt-3 text-muted small align-items-center">
        <button type="button" class="btn btn-sm btn-outline-success upvote-btn" data-post-id="{{ post.id }}" title="Upvote">
          ‚ñ≤ <span class="upvote-count">{{ post.upvotes.count }}</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-danger downvote-btn" data-post-id="{{ post.id }}" title="Downvote">
          ‚ñº <span class="downvote-count">{{ post.downvotes.count }}</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary comment-btn" data-post-id="{{ post.id }}" title="B√¨nh lu·∫≠n">
          üí¨ <span class="comment-count">{{ post.comments.count }}</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary share-btn" data-post-id="{{ post.id }}" title="Chia s·∫ª">
          üîó <span class="share-text">Chia s·∫ª</span>
        </button>
      </div>

      <div id="comments-{{ post.id }}" class="d-none">
        <div class="comments-list">
          {% for c in post.comments.all %}
          <div class="card mb-2 comment-card" data-comment-id="{{ c.id }}">
          <div class="card-body p-2">
            <div>
              <div class="fw-semibold small">{{ c.author.user.username }} <span class="text-muted small">‚Ä¢ {{ c.created_at|date:'d M Y H:i' }}</span></div>
              <div class="small mt-1">{{ c.content|safe }}</div>
            </div>
            <div class="text-end mt-2">
              <button type="button" class="btn btn-sm btn-outline-success comment-upvote" data-comment-id="{{ c.id }}">‚ñ≤ <span class="badge bg-transparent text-success">{{ c.upvotes.count }}</span></button>
              <button type="button" class="btn btn-sm btn-outline-danger comment-downvote" data-comment-id="{{ c.id }}">‚ñº <span class="badge bg-transparent text-danger">{{ c.downvotes.count }}</span></button>
            </div>
          </div>
          </div>
          {% endfor %}
        </div>
      </div>
        </article>
        {% empty %}
        <div class="post-card text-center text-muted">Ch∆∞a c√≥ b√†i vi·∫øt n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n ƒëƒÉng b√†i!</div>
        {% endfor %}
    </div>

    <!-- bottom navbar copied from home.html -->
    <nav class="navbar navbar-light bg-white border-top fixed-bottom">
      <div class="container d-flex justify-content-around py-2">
        <a href="/" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill" viewBox="0 0 16 16">
            <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
            <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1m9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0"/>
          </svg>
        </a>

        <a href="/community" class="d-flex flex-column align-items-center text-decoration-none text-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-square-quote-fill" viewBox="0 0 16 16">
            <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2zm7.194 2.766a1.7 1.7 0 0 0-.227-.272 1.5 1.5 0 0 0-.469-.324l-.008-.004A1.8 1.8 0 0 0 5.734 4C4.776 4 4 4.746 4 5.667c0 .92.776 1.666 1.734 1.666.343 0 .662-.095.931-.26-.137.389-.39.804-.81 1.22a.405.405 0 0 0 .011.59c.173.16.447.155.614-.01 1.334-1.329 1.37-2.758.941-3.706a2.5 2.5 0 0 0-.227-.4zM11 7.073c-.136.389-.39.804-.81 1.22a.405.405 0 0 0 .012.59c.172.16.446.155.613-.01 1.334-1.329 1.37-2.758.942-3.706a2.5 2.5 0 0 0-.228-.4 1.7 1.7 0 0 0-.227-.273 1.5 1.5 0 0 0-.469-.324l-.008-.004A1.8 1.8 0 0 0 10.07 4c-.957 0-1.734.746-1.734 1.667 0 .92.777 1.666 1.734 1.666.343 0 .662-.095.931-.26"/>
          </svg>
        </a>

        <a href="/chatbot" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mb-1" viewBox="0 0 16 16">
            <path d="M2 2h12v9H5.414L3 13.414V2z"/>
          </svg>
        </a>

        <a href="/pharmacy" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-capsule-pill" viewBox="0 0 16 16">
            <path d="M11.02 5.364a3 3 0 0 0-4.242-4.243L1.121 6.778a3 3 0 1 0 4.243 4.243l5.657-5.657Zm-6.413-.657 2.878-2.879a2 2 0 1 1 2.829 2.829L7.435 7.536zM12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8m-.5 1.042a3 3 0 0 0 0 5.917zm1 5.917a3 3 0 0 0 0-5.917z"/>
          </svg>
        </a>

        <a href="/profile" class="d-flex flex-column align-items-center text-decoration-none text-muted">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
          </svg>
        </a>
      </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- TinyMCE -->
  <script src="https://cdn.tiny.cloud/1/m7h9it70s3fcl5aux1hik5lcn1ik3f5bl9mro9q73oa7jzvn/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
  <script>
    tinymce.init({
      selector: '#tinyContent',
      menubar: false,
      plugins: 'link lists code paste image',
      toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | bullist numlist | link | removeformat',
      branding: false,
      height: 200,
      paste_as_text: false,
      forced_root_block: 'p',
      relative_urls: false,
      convert_urls: true,
      valid_elements: 'a[href|target|rel],strong/b,em/i,p,ul,ol,li,br,hr,pre,code,img[src|alt|title]',
      setup: function (editor) {
        editor.on('submit', function (e) {
          editor.save();
        });
      }
    });
  </script>
  <script>
    // helper to read csrftoken from cookies
    function getCsrfToken(){
      const name = 'csrftoken=';
      const cookies = document.cookie.split(';');
      for(const c of cookies){
        const t = c.trim(); if(t.startsWith(name)) return t.substring(name.length);
      }
      return '';
    }

    // Defensive client-side sanitizer to remove Django template markers
    function sanitizeTemplateTags(html){
      if(!html) return html;
      try{
        html = html.replace(/\{\%[\s\S]*?\%\}/g, '');
        html = html.replace(/\{\{[\s\S]*?\}\}/g, '');
      }catch(e){ /* ignore */ }
      return html;
    }

    // Vote handlers
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.upvote-btn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const postId = btn.dataset.postId;
          try{
            const resp = await fetch(`/post/${postId}/vote/`, {
              method: 'POST', headers: {
                'Content-Type':'application/json', 'X-CSRFToken': getCsrfToken()
              }, body: JSON.stringify({ action: 'up' })
            });
            if(resp.ok){ const data = await resp.json(); btn.querySelector('.upvote-count').textContent = data.upvotes; const down = btn.closest('.post-actions').querySelector('.downvote-count'); if(down) down.textContent = data.downvotes; }
          }catch(e){ console.error(e); }
        });
      });

      document.querySelectorAll('.downvote-btn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const postId = btn.dataset.postId;
          try{
            const resp = await fetch(`/post/${postId}/vote/`, {
              method: 'POST', headers: {
                'Content-Type':'application/json', 'X-CSRFToken': getCsrfToken()
              }, body: JSON.stringify({ action: 'down' })
            });
            if(resp.ok){ const data = await resp.json(); btn.querySelector('.downvote-count').textContent = data.downvotes; const up = btn.closest('.post-actions').querySelector('.upvote-count'); if(up) up.textContent = data.upvotes; }
          }catch(e){ console.error(e); }
        });
      });

      // Comments modal logic
      const commentsModalEl = document.createElement('div');
      commentsModalEl.innerHTML = `
        <div class="modal fade" id="commentsModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
              <div class="modal-header"><h5 class="modal-title">B√¨nh lu·∫≠n</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
              <div class="modal-body">
                <div id="commentsContainer"></div>
                <div>
                  <textarea id="commentInput" class="form-control" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."></textarea>
                </div>
              </div>
              <div class="modal-footer d-flex gap-2">
                <button id="submitComment" class="btn btn-primary">G·ª≠i</button>
              </div>
            </div>
          </div>
        </div>`;
      document.body.appendChild(commentsModalEl);

      const commentsModal = new bootstrap.Modal(document.getElementById('commentsModal'));
      let currentPostForComments = null;

      document.querySelectorAll('.comment-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const postId = btn.dataset.postId;
          currentPostForComments = postId;
          // populate modal with hidden comments
          const hidden = document.getElementById(`comments-${postId}`);
          const container = document.getElementById('commentsContainer');
          // If there is a server-rendered hidden comments-list, clone each comment-card
          // but sanitize only the comment content block so author/date and buttons (rendered server-side)
          // remain intact.
          if(hidden){
            container.innerHTML = ''; // clear
            const cards = hidden.querySelectorAll('.comment-card');
            if(cards.length){
              cards.forEach(origCard=>{
                const card = origCard.cloneNode(true);
                // find the content block inside the card and sanitize it
                const contentEl = card.querySelector('.card-body .small.mt-1') || card.querySelector('.card-body .small');
                if(contentEl) contentEl.innerHTML = sanitizeTemplateTags(contentEl.innerHTML || '');
                container.appendChild(card);
              });
            } else {
              container.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</div>';
            }
          } else {
            container.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</div>';
          }
          document.getElementById('commentInput').value = '';
          commentsModal.show();
        });
      });

      // Create a reusable toast for copy feedback
      (function createCopyToast(){
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
            <div id="copyToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">ƒê√£ sao ch√©p li√™n k·∫øt</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>
          </div>`;
        document.body.appendChild(wrapper);
      })();
      const copyToastEl = document.getElementById('copyToast');
      const copyToast = copyToastEl ? new bootstrap.Toast(copyToastEl) : null;

      document.querySelectorAll('.share-btn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const postId = btn.dataset.postId;
          const url = `${window.location.origin}/post/${postId}/`;
          try{
            await navigator.clipboard.writeText(url);
            if(copyToast){ copyToastEl.querySelector('.toast-body').textContent = 'ƒê√£ sao ch√©p li√™n k·∫øt'; copyToast.show(); }
          }catch(e){ console.error('Clipboard failed', e); alert('Kh√¥ng th·ªÉ sao ch√©p li√™n k·∫øt'); }
        });
      });

      // Initialize TinyMCE for comment input inside modal
      tinymce.init({
        selector: '#commentInput',
        menubar: false,
        plugins: 'link lists',
        toolbar: 'bold italic | bullist numlist | link | removeformat',
        branding: false,
        height: 140,
        forced_root_block: 'p',
        relative_urls: false,
        convert_urls: true,
        setup: function (editor) { editor.on('change', function () { editor.save(); }); }
      });

      // Per-comment vote handlers
      function attachCommentVoteHandlers(root=document){
        root.querySelectorAll('.comment-upvote').forEach(btn=>{
          if(btn.dataset.bound) return; btn.dataset.bound = '1';
          btn.addEventListener('click', async ()=>{
            const cid = btn.dataset.commentId;
            try{
              const resp = await fetch(`/comment/${cid}/vote/`, { method: 'POST', headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCsrfToken() }, body: JSON.stringify({ action: 'up' }) });
              if(resp.ok){ const data = await resp.json(); btn.querySelector('span').textContent = data.upvotes; const sibling = btn.closest('.comment-card').querySelector('.comment-downvote span'); if(sibling) sibling.textContent = data.downvotes; }
            }catch(e){ console.error(e); }
          });
        });

        root.querySelectorAll('.comment-downvote').forEach(btn=>{
          if(btn.dataset.bound) return; btn.dataset.bound = '1';
          btn.addEventListener('click', async ()=>{
            const cid = btn.dataset.commentId;
            try{
              const resp = await fetch(`/comment/${cid}/vote/`, { method: 'POST', headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCsrfToken() }, body: JSON.stringify({ action: 'down' }) });
              if(resp.ok){ const data = await resp.json(); btn.querySelector('span').textContent = data.downvotes; const sibling = btn.closest('.comment-card').querySelector('.comment-upvote span'); if(sibling) sibling.textContent = data.upvotes; }
            }catch(e){ console.error(e); }
          });
        });
      }

      // Attach handlers to initial hidden comment lists
      document.querySelectorAll('.comments-list').forEach(el=>attachCommentVoteHandlers(el));

      // When modal is populated, attach handlers to dynamic content
      const observer = new MutationObserver(()=>{ attachCommentVoteHandlers(document.getElementById('commentsContainer')); });
      observer.observe(document.getElementById('commentsContainer'), { childList: true, subtree: true });

      document.getElementById('submitComment').addEventListener('click', async ()=>{
        const txt = document.getElementById('commentInput').value.trim();
        if(!txt || !currentPostForComments) return;
        try{
          const resp = await fetch(`/post/${currentPostForComments}/comment/`, {
            method: 'POST', headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCsrfToken() }, body: JSON.stringify({ content: txt })
          });
          if(resp.ok){ const data = await resp.json();
            const container = document.getElementById('commentsContainer');
            const card = document.createElement('div');
            card.className = 'card mb-2 comment-card';
            card.dataset.commentId = data.id;
            // Sanitize server-returned HTML for safety (remove any stray template tokens)
            const safeHtml = sanitizeTemplateTags(data.content_html || '');
            card.innerHTML = `
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold small">${data.author} <span class="text-muted small">‚Ä¢ ${data.created_at}</span></div>
                    <div class="small mt-1">${safeHtml}</div>
                  </div>
                  <div class="text-end ms-3">
                    <button type="button" class="btn btn-sm btn-outline-success comment-upvote" data-comment-id="${data.id}">‚ñ≤ <span class="badge bg-transparent text-success">0</span></button>
                    <button type="button" class="btn btn-sm btn-outline-danger comment-downvote" data-comment-id="${data.id}">‚ñº <span class="badge bg-transparent text-danger">0</span></button>
                  </div>
                </div>
              </div>`;
            container.prepend(card);
            // also prepend to hidden container so subsequent opens include it (clone)
            const hidden = document.getElementById(`comments-${currentPostForComments}`);
            if(hidden){ hidden.querySelector('.comments-list').prepend(card.cloneNode(true)); }
            document.getElementById('commentInput').value = '';
          } else { console.error('Comment failed', await resp.text()); }
        }catch(e){ console.error(e); }
      });
    });
  </script>
</body>
</html>
